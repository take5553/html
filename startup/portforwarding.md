# 外出先（外部ネットワーク）からSSH接続するためのルーター設定

## やりたいこと

現在の状態では家の中でならRaspberry Piにリモート接続できるけど、家の外からはできない。それをできるようにする。

## 方法

### ポートフォワーディング（またはポート開放）

これは各ルーターによって違うので「（ルーターの型番） ポートフォワーディング」とかでググる。昔のポート開放と呼ばれていたもので、ルーターによって名称が違う。

とは言え、それだけでは探しにくいので、検索のヒントになるように、ポートフォワーディングの概要を載せておく。

### ポートフォワーディングの概要

[Raspberry Pi立ち上げの記事](startup1.html)でローカルIPとグローバルIPの説明をしたので読んでおいてほしい。

同じ家の中にあるPCのPowerShellから、Raspberry PiのIPを使って接続したが、家の外に出るとできない。ローカルIPは内線番号なので当然外に出ると使えない。

じゃあグローバルIPならいいのかというとそうでもない。というのも、家の中の機器は同じルーターに繋がっている限りすべて同じグローバルIPを持つから、グローバルIPを打ち込んでもそれがPCなのかRaspberry PiなのかPS4なのかスマホなのか分からない。

グローバルIPとは、いわばルーターの（外向けの）IPであり、家の中のPCがインターネットにアクセスできるのは、実はPCの代わりにルーターが外部のインターネットに接続して代わりにWebページなりYouTubeなりを取ってきてくれてる（表現は多分正確じゃないと思うけど、的外れではないはず）。だからPCからだろうがRaspberry Piからだろうがブラウザで[確認くん](https://www.ugtop.com/spill.shtml)にアクセスすると同じIPが表示される。

じゃあどうやって外部から家の中のRaspberry Piに接続すればいいのかというと、ルーターの「ポート」を使う。

[ポート \(port\)とは｜「分かりそう」で「分からない」でも「分かった」気になれるIT用語辞典](https://wa3.i-3-i.info/word1774.html)

「IPは住所、ポートはドア」とよく言われる。IPという住所が分かったから突撃したらドアが65536個もあって「どれやねん！」と困る、みたいな。

ルーターもポートを65536個持っているけど、ほぼガラガラ。なので適当に「ルーターの指定ポートに問い合わせが来たら、Raspberry Piの指定ポートにそのまま渡してね」というルールを作ってあげると、グローバルIP＋ポートの組み合わせでちゃんとRaspberry Piに通信が届く。

このルールのことをポートフォワーディング、またはポート開放と言う。

## 例

自分のルーターの設定画面を晒すのは怖い。（ビビり）

### 架空設定

適当にフレッツ光に加入しているとして、「ホームゲートウェイPR-600」というルーターをもらったとする。このルーターの設定をして外部からRaspberry Piに繋がるようにする。

### ポート開放の方法

「ホームゲートウェイPR-600　ポート開放」で検索するとトップに以下のページが出てきた。

[フレッツホームゲートウェイ PR\-600 / RX\-600 シリーズの特徴とポート開放設定の説明 \| インターネット接続解説ブログKAGEMARU\-info](https://www.akakagemaru.info/port/pr600-portfw.html)

このとき

* 準備IPアドレスを固定する

  ここではRaspberry PiのIPを固定することになるが、[立ち上げ時の記事](startup1.html)ですでにしている

* ポート開放設定説明

  静的IPマスカレード設定のところで以下のように設定する

  * 変換対象プロトコル：TCP
  * 変換対象ポート：何か適当に決める（ただし1024～65535の間、この項目で22は絶対に避ける）
  * 宛先IPアドレス：Raspberry PiのローカルIP
  * 宛先ポート：22（または[SSHの設定時](sshsettings.html)にポートを変更している場合はそのポートを指定）

### もう少し具体的に

* ホームゲートウェイPR-600に割り当てられたグローバルIP：`11.22.33.44`
* ホームゲートウェイPR-600のポートのうち外部からの通信を待ち受けるポート：`12345`
* Raspberry Piに設定したローカルIP：`192.168.1.201`
* [SSHの設定](sshsettings.html)で設定したポート番号：`22`

とした場合

* 変換対象プロトコル：TCP
* 変換対象ポート：`12345`
* 宛先IPアドレス：`192.168.1.201`
* 宛先ポート：`22`

と設定し、**家の外に出てカフェとかに行き**無料WifiにつないだノートPCのPowerShellから以下を打つ。

~~~shell
> ssh takeshi@11.22.33.44 -p 12345
~~~

そうするとルーターの中で`192.168.1.201`の`22`番ポート宛に変換してくれて、Raspberry PiとSSH接続ができる。

どうしても家の中でやりたい！という人は

* スマホにSSHクライアント（Androidだったら[JuiceSSH](https://play.google.com/store/apps/details?id=com.sonelli.juicessh&hl=ja)がおすすめ。iOSは知らん。）をインストール。
  * JuiceSSHだったら以下を参考に新しい接続設定を作る。
    1. Manage Connectionsをクリック
    2. Identitiesを選択し＋ボタンをクリック
       * Nickname：分かりやすい名前
       * Username：Raspberry Piのユーザー名
       * Password：（無視）
       * Private Key：クリックしてPASTEを選択後以下
         1. PC上に保管してある秘密鍵をテキストエディタで開く
         2. 全文コピーしてGmailにペーストし下書き保存
         3. スマホからGmailを開き、下書きから秘密鍵全文をコピー
         4. 下書き削除
         5. JuiceSSHの画面に戻り秘密鍵をペースト
    3. 右上のチェックマークをクリック
    4. 次にConnectionsを選択し＋ボタンをクリック
       * Nickname：分かりやすい名前
       * Type：SSH
       * Address：`11.22.33.44`
       * Identity：今作ったIdentityを選択
       * Port：`12345`
    5. 接続設定を作ると同時に接続しようとするのでWifiを切っておく
    6. 右上のチェックマークをクリック

Wifiにつないでない場合のスマホは外部ネットワーク扱いになるので、これで繋がればどこでも繋がる。

## 疑問

ネットを探すとRaspberry Piのセキュリティ設定を一生懸命している人がいるけど、ルーターのセキュリティがしっかりしてたら後は`root`ログイン禁止とパスワードログイン禁止、`pi`ユーザーの削除ぐらいでいいんじゃない？他の項目は初期値でしっかり設定されてるし。

特にSSHのポート変更、Raspberry Piのポートは変える必要が無くてルーターの開放ポートで22番を避ければいいんじゃない？

Raspberry PiのOSはLinuxだから「Linux　セキュリティ設定」とかで調べると色々出てくるけど、そういう情報ってグローバルIPがダイレクトに割り当てられるようなLinuxサーバー用だから、それをマネしてローカルIPしか割り当てないRaspberry Piに一生懸命セキュリティ設定しても意味ないような気がする。

逆にRaspberry PiにグローバルIPが割り当たって外部ネットワークに直接晒されるなら、他のLinuxサーバーと同じセキュリティが必要だと思う。

