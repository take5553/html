# Nginxの設定ファイル `/etc/nginx/sites-available/default`

## 環境

- ローカル（PC側）
  - Windows10
  - PowerShell 5.1
- リモート（Raspberry Pi）
  - Raspberry Pi 3B+
  - Raspberry Pi OS 10.4
  - Nginx 1.14.2
  - PHP 7.3.19-1~deb10u1

## `sites-available/default`の中身

[前回](nginx-conf.html)の続き。ここには[Certbotが書き込んだ設定](letsencrypt.html)もあるので初期状態ではないかもしれない。

~~~
##
# You should look at the following URL's in order to grasp a solid understanding
# of Nginx configuration files in order to fully unleash the power of Nginx.
# https://www.nginx.com/resources/wiki/start/
# https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/
# https://wiki.debian.org/Nginx/DirectoryStructure
#
# In most cases, administrators will remove this file from sites-enabled/ and
# leave it as reference inside of sites-available where it will continue to be
# updated by the nginx packaging team.
#
# This file will automatically load configuration files provided by other
# applications, such as Drupal or Wordpress. These applications will be made
# available underneath a path with that package name, such as /drupal8.
#
# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
##

# Default server configuration
#
server {
        listen 80 default_server;
        listen [::]:80 default_server;

        # SSL configuration
        #
        # listen 443 ssl default_server;
        # listen [::]:443 ssl default_server;
        #
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        #
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        #
        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        #
        # include snippets/snakeoil.conf;

        root /home/takeshi/www/html;

        # Add index.php to the list if you are using PHP
        index index.php index.html index.htm index.nginx-debian.html;

        server_name _;

        location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                try_files $uri $uri/ =404;
        }

        # pass PHP scripts to FastCGI server
        #
        location ~ \.php$ {
                include snippets/fastcgi-php.conf;

        #       # With php-fpm (or other unix sockets):
                fastcgi_pass unix:/run/php/php7.3-fpm.sock;
        #       # With php-cgi (or other tcp sockets):
        #       fastcgi_pass 127.0.0.1:9000;
        }

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #       deny all;
        #}
}


# Virtual Host configuration for example.com
#
# You can move that to a different file under sites-available/ and symlink that
# to sites-enabled/ to enable it.
#
#server {
#       listen 80;
#       listen [::]:80;
#
#       server_name example.com;
#
#       root /var/www/example.com;
#       index index.html;
#
#       location / {
#               try_files $uri $uri/ =404;
#       }
#}

server {

        # SSL configuration
        #
        # listen 443 ssl default_server;
        # listen [::]:443 ssl default_server;
        #
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        #
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        #
        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        #
        # include snippets/snakeoil.conf;

        root /home/takeshi/www/html;

        # Add index.php to the list if you are using PHP
        index index.php index.html index.htm index.nginx-debian.html;
    server_name arcticstreet.ddns.net; # managed by Certbot


        location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                try_files $uri $uri/ =404;
        }

        # pass PHP scripts to FastCGI server
        #
        location ~ \.php$ {
                include snippets/fastcgi-php.conf;

        #       # With php-fpm (or other unix sockets):
                fastcgi_pass unix:/run/php/php7.3-fpm.sock;
        #       # With php-cgi (or other tcp sockets):
        #       fastcgi_pass 127.0.0.1:9000;
        }

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #       deny all;
        #}


    listen [::]:443 ssl ipv6only=on; # managed by Certbot
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/arcticstreet.ddns.net/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/arcticstreet.ddns.net/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

}
server {
    if ($host = arcticstreet.ddns.net) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


        listen 80 ;
        listen [::]:80 ;
    server_name arcticstreet.ddns.net;
    return 404; # managed by Certbot


}
~~~

コメントを削除し、少し整形する。

~~~
server {
        listen 80 default_server;
        listen [::]:80 default_server;

        root /home/takeshi/www/html;

        index index.php index.html index.htm index.nginx-debian.html;

        server_name _;

        location / {
                try_files $uri $uri/ =404;
        }

        location ~ \.php$ {
                include snippets/fastcgi-php.conf;
                fastcgi_pass unix:/run/php/php7.3-fpm.sock;
        }

}

server {

        root /home/takeshi/www/html;

        index index.php index.html index.htm index.nginx-debian.html;
        
        server_name arcticstreet.ddns.net; # managed by Certbot

        location / {
                try_files $uri $uri/ =404;
        }

        location ~ \.php$ {
                include snippets/fastcgi-php.conf;
                fastcgi_pass unix:/run/php/php7.3-fpm.sock;
		}

        listen [::]:443 ssl ipv6only=on; # managed by Certbot
        listen 443 ssl; # managed by Certbot
        ssl_certificate /etc/letsencrypt/live/arcticstreet.ddns.net/fullchain.pem; # managed by Certbot
        ssl_certificate_key /etc/letsencrypt/live/arcticstreet.ddns.net/privkey.pem; # managed by Certbot
        include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

}

server {

        if ($host = arcticstreet.ddns.net) {
            return 301 https://$host$request_uri;
        } # managed by Certbot

        listen 80 ;
        listen [::]:80 ;
        server_name arcticstreet.ddns.net;
        return 404; # managed by Certbot
        
}
~~~

色々書いてて見にくいが、結局のところ

~~~
server {
        ...
}
~~~

が3つ書いてあるだけ。推測だけど、最初の`server`コンテキストが元々あった設定で、残り2つはCertbotが自動で書いた設定っぽい。上から順番に見ていく。

### `server`コンテキストの中身

このコンテキストは、バーチャルサーバーを設定する。バーチャルサーバーとは「物理サーバーとしては1つしかないけど、設定によってあたかも複数のサーバーが存在するように見せる」ということ。バーチャルホストとも呼ばれる。

#### バーチャルサーバーとは

本来は一つの物理サーバー（Raspberry Piのようなサーバーマシン）に対して、中にインストールするWebサーバー（今回の場合Nginx）も一つ。Webサーバーは80番ポートに聞き耳を立てていて、何かリクエストが来るとそれに応じて必要なレスポンスを返す。

でもWebサーバーは起動している大部分の時間は暇をしている。なので「おい、81番ポートに来たリクエストも拾って、あたかも2つのNginxが動いてるように見せかけろよ」と命じることができる。

ここで、81番ポートに対するレスポンスはどうすればいいのか、ということを`server`コンテキストの中に書いてあげる、というわけ。

実際はポートだけではなく、ドメイン（うちのサイトで言う`arcticstreet.ddns.net`）に対しても対応を分けることができる。

例えば`hogehoge.foobar.com`というドメインも同じように名前解決ができ、うちのRaspberry PiのIP（正確に言うと自宅ルーターのIP）に紐づいているとする。そうするとRaspberry Piは「`arcticstreet.ddns.net`宛のリクエスト」と「`hogehoge.foobar.com`宛のリクエスト」を今後受け取ることになる。その時「`hogehoge.foobar.com`宛のリクエストに対しても対応を分け、あたかも別サーバーが動いてるように見せかけなさい」と命じることができる。

どれだけバーチャルサーバーを増やしたとしても、自分の手元にあるのは1台のRaspberry Piと1つのWebサーバー（Nginx）だけ。

#### `listen`ディレクティブ

その名の通り、NginxがリッスンしているポートとかIPを指定する。

~~~
        listen 80 default_server;
        listen [::]:80 default_server;
~~~

`listen [::]:80`は、`[::]`の部分がIPv6の任意のアドレスを指す、ということらしい。

`default_server`はその名の通りこれをデフォルトとするということ。詳細不明。

#### `root`ディレクティブ

ドキュメントルート。これは[以前設定したもの](update1.html)。

~~~
        root /home/takeshi/www/html;
~~~

前回は`/etc/nginx/sites-enabled/default`を編集したという書きぶりだったけど、これまで見たように`sites-enabled`ディレクトリに入っているのはシンボリックリンクで、実際編集したのは`/etc/nginx/sites-available/default`というファイル。

#### `index`ディレクティブ

デフォルトのインデックスは何なのかを指定する。

~~~
        index index.php index.html index.htm index.nginx-debian.html;
~~~

#### `server_name`ディレクティブ

ホスト名を設定。例えば以下のようにしたいとき、

* `arcticstreet.ddns.net`でアクセス　・・・　通常の表示
* `www.arcticstreet.ddns.net`でアクセス　・・・　別サイトを表示
* `blog.arcticstreet.ddns.net`でアクセス　・・・　ブログを表示

以下の様に書けば、それぞれの`server`ディレクティブの内容が適用される。

~~~
server {
		server_name arcticstreet.ddns.net;
		（通常の設定）
}

server {
		server_name www.arcticstreet.ddns.net;
		（別サイトを表示する設定）
}

server {
		server_name blog.arcticstreet.ddns.net;
		（ブログに直接飛ぶような設定）
}
~~~

ただし、`www.arcticstreet.ddns.net`や`blog.arcticstreet.ddns.net`で名前解決（ドメイン名からIPアドレスを取得すること）ができることが前提。

※うちで使っている[No-IP](https://www.noip.com/)では、上のようなアクセスを許可する設定にするにはワイルドカードを有効にしないといけなく、それは有料プランだそうだ。

以下のように書けば、他の全てのホスト名に対する設定が書ける。

~~~
        server_name _;
~~~

#### `location`ディレクティブ

リクエストURIのパスが、このディレクティブのパスに一致した場合の処理を記述する。

~~~
        location (optional prefix) (path) {
                ...
        }
~~~

`path`に`/`を指定すると、他の`location`ディレクティブに一致しないときに適用される。

`prefix`は省略可能で、以下のものを付与することができる。

| prefix | 意味                               |
| ------ | ---------------------------------- |
| `=`    | 完全一致                           |
| `~`    | 正規表現（大文字小文字を区別）     |
| `~*`   | 正規表現（大文字小文字の区別なし） |
| `^~`   | 前方一致（後方参照無し）           |
| なし   | 前方一致（後方参照有り）           |

後方参照無しの場合、一致した時点で残りは見ないという挙動になる。[nginx連載5回目: nginxの設定、その3 \- locationディレクティブ \- インフラエンジニアway \- Powered by HEARTBEATS](https://heartbeats.jp/hbblog/2012/04/nginx05.html)に詳しい説明が載っている。

ちなみに、正規表現を使用するときは、`path`の最後に`$`を付けるらしい。

よって以下は、`.php`で終わるファイルがリクエストされたときの挙動を記述している。

~~~
        location ~ \.php$ {
                include snippets/fastcgi-php.conf;
                fastcgi_pass unix:/run/php/php7.3-fpm.sock;
        }
~~~

`snippets/fastcgi-php.conf`の内容と、`fastcgi_pass`の意味はまた[別記事](nginx-conf3.html)で。

#### `try_files`ディレクティブ

ファイルを見つけに行くときの挙動を指定する。

~~~
            try_files $uri $uri/ =404;
~~~

`$uri`には、ドメイン名より後ろの文字列で、パラメーターを除いたものが格納される。

| リクエストURL                                   | `$uri`の中身 |
| ----------------------------------------------- | ------------ |
| `https://artcticstreet.ddns.net/`               | `/`          |
| `https://artcticstreet.ddns.net/webserver`      | `/webserver` |
| `https://artcticstreet.ddns.net/webserver?id=1` | `/wevserver` |

参考：[nginx Embedded Variablesの一覧 \- Qiita](https://qiita.com/r-ytakada/items/ebe943366f59d29e0a50)

`try_files`に渡される引数が順番で処理される。

よって、`try_files $uri $uri/ =404;`という書き方だと、ドキュメントルートが`/home/takeshi/www/html`だったとして、

1. ドキュメントルート＋`$uri`でファイルにアクセスできるかどうか

   つまり`/home/takeshi/www/html/webserver`というファイルがあるかどうか→無し

2. ドキュメントルート＋`$uri`＋`/`（つまりディレクトリ）にアクセスできるかどうか

   `/home/takeshi/www/html/webserver/`というディレクトリは存在する→ファイル名は省略されているので`index`ディレクティブで指定されているファイル名を順番に試し、見つかったものをレスポンスとして返す。

3. もし1.でも2.でも見つからない場合、`404`コードを返す。

ということになる。

#### SSL関係

~~~
        listen [::]:443 ssl ipv6only=on; # managed by Certbot
        listen 443 ssl; # managed by Certbot
        ssl_certificate /etc/letsencrypt/live/arcticstreet.ddns.net/fullchain.pem; # managed by Certbot
        ssl_certificate_key /etc/letsencrypt/live/arcticstreet.ddns.net/privkey.pem; # managed by Certbot
        include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
~~~

書いてあるように、これらはCertbotが挿入したもの。必要があったら詳しく調べてみることにするので、今はそっとしておく。

#### リダイレクト関係

~~~
server {

        if ($host = arcticstreet.ddns.net) {
            return 301 https://$host$request_uri;
        } # managed by Certbot

        listen 80 ;
        listen [::]:80 ;
        server_name arcticstreet.ddns.net;
        return 404; # managed by Certbot
        
}
~~~

これもCertbotが挿入したもの。[Let's Encryptを導入したとき](letsencrypt.html)にHTTP接続をHTTPS接続にリダイレクトするかどうか聞かれた結果だと思われる。

[続く](nginx-conf3.html)

## 参考

[nginx documentation](https://nginx.org/en/docs/#introduction)
[Centos \- bnote](https://www.bnote.net/centos.html)
[nginxについてまとめ\(設定編\) \- Qiita](https://qiita.com/morrr/items/7c97f0d2e46f7a8ec967)
[nginxの設定ファイル nginx\.conf の読み方 超入門 – 或る阿呆の記](https://hack-le.com/nginx/)
[Nginx設定編④serverディレクティブを読む。Linuxサーバ構築手順まとめ \| TECH Projin](https://tech.pjin.jp/blog/2014/09/24/nginx%e8%a8%ad%e5%ae%9a%e7%b7%a8%e2%91%a3server%e3%83%87%e3%82%a3%e3%83%ac%e3%82%af%e3%83%86%e3%82%a3%e3%83%96%e3%82%92%e8%aa%ad%e3%82%80%e3%80%82linux%e3%82%b5%e3%83%bc%e3%83%90%e6%a7%8b%e7%af%89/)

