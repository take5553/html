# HTML更新（手動）

## やりたいこと

* ローカルマシン（PC等）の`D:\`直下に`update1.html`という名前のhtmlファイルがすでに出来上がっている
* Raspberry Pi上のNginxのドキュメントルート（公開するhtmlファイルなどを入れておく場所）が`/var/www/html`

この状態のとき、`scp`コマンドでhtmlファイルを送信する。

## 環境

+ ローカル（PC側）
  * Windows10
  * Powershell 5.1
+ リモート（Raspberry Pi）
  * Raspberry Pi 3B+
  * Raspberry Pi OS 10.4
  * Nginx 1.14.2 (インストール直後)

## 調べて分かったこと

`/var/www/html`は`root`ユーザーが所有者となっているので

1. `/var/www/html`の権限を変更する
2. 権限が及ぶ場所にディレクトリを新たに作り、Nginxのドキュメントルートの設定を変更する

のどちらかを行う必要がある。

この記事では2.を行う。

## 方法

* `var/www/html`の権限確認。

  ~~~shell
  $ ls -l /var/www
  total 4
  drwxr-xr-x 2 root root 4096 Sep 11 21:42 html
  ~~~

  `root`ユーザーにのみ書き込み権限が与えられている。これは`root`ユーザー以外は`var/www/html`ディレクトリに書き込み（ファイル追加）ができないことを意味する。

* 自分のホームディレクトリに新たにディレクトリを作る。

  ~~~shell
  $ mkdir ~/www/html -p
  ~~~

  権限確認。

  ~~~shell
  $ls -l www
  total 4
  drwxr-xr-x 2 (自分のユーザー名) (自分のユーザーグループ) 4096 Sep 19 11:42 html
  ~~~

* Nginxのドキュメントルート設定を変える

  設定ファイルを開く。

  ~~~shell
  $ sudo nano /etc/nginx/sites-enabled/default
  ~~~

  41行目ぐらいにある`root`で始まる行を書き換える。

  ~~~
  root /var/www/html
  ↓
  root /home/(ユーザー名)/www/html
  ~~~

  Nginxを再起動し、設定ファイルを読み込む。

  ~~~shell
  $ sudo /etc/init.d/nginx reload
  ~~~

* PowerShellから`scp`コマンドでファイルが送信できるかどうか確認。

  ~~~shell
  > scp d:\update1.html (ユーザー名)@(ラズパイのIP):~/www/html
  update1.html                       100%   28KB   1.7MB/s   00:00
  ~~~

  成功。
  
  Raspberry Pi上で権限確認。
  
  ~~~shell
  $ ls -l ~/www/html
  total 0
  -rw-r--r-- 1 (ユーザー名) (ユーザーグループ) 0 Sep 19 13:37 update1.html
  ~~~

## 解説

### `scp`コマンド

ローカルからリモートへ（またはリモートからローカルへ）SSH接続経由でファイルを送信するコマンド。書式は以下。

~~~shell
> scp 送信元ファイル 送信先
~~~

* アップロード（ローカルからリモートへ送信）
  * 送信元ファイルの書式・・・`d:\update.html`など通常のファイルパス
  * 送信先の書式・・・`(ユーザー名)@(リモートのIPアドレス):(フォルダへのパス)`

* ダウンロード（リモートからローカルへ送信）

  * 送信元ファイルの書式・・・`(ユーザー名)@(リモートのIPアドレス):(ファイルへのパス)`
  * 送信先の書式・・・`d:\`など通常のフォルダパス

これで指定ユーザーでリモートにログインし、ファイルを転送する。

* 秘密鍵指定オプション：`-i (秘密鍵ファイルのパス)`

  もし公開鍵認証を設定しているならログインするのに秘密鍵が必要。このオプションを指定しなければデフォルト値の`c:\Users\(Winのユーザー名)\.ssh\id_rsa`が使用される。

* ポート指定オプション：`-P (ポート番号)`

  SSH接続で使用するポートをデフォルトの`22`から変更しているなら指定が必要。省略したら`22`が指定される。

その他のオプションは各自で調べること。

### ファイル・ディレクトリの権限確認

~~~shell
$ ls -l (対象のファイルまたはディレクトリ)
~~~

`ls`コマンドはファイル名やディレクトリ名を表示するコマンドだけど、`-l`を付けるとファイルの属性（所有者、更新日時など）が確認できる。

記事中に出てきた

~~~shell
$ ls -l /var/www
total 4
drwxr-xr-x 2 root root 4096 Sep 11 21:42 html
~~~

という結果の、特に関係ある部分だけ解説する。

* `drwxr-xr-x`

  これは先頭の`d`と`rwx`、`r-x`、`r-x`という3組に分けて見る。

  * 先頭の`d`

    これはそれがディレクトリであることを表している。ここが`-`だったらそれがファイルであることを表している。

  * 最初の組`rwx`

    これは所有者（この例では`root`ユーザー）がこのファイル・ディレクトリに対してどんな権限を持っているかを示す。

    * `r`・・・読み込み権限：有り
    * `w`・・・書き込み権限：有り
    * `x`・・・実行権限：有り

  * 次の組`r-x`

    これは所属グループ（この例では`root`グループ）のメンバーがこのファイル・ディレクトリに対してどんな権限を持っているかを示す。

    * `r`・・・読み込み権限：有り
    * `-`・・・書き込み権限：無し
    * `x`・・・実行権限：有り

  * 最後の組`r-x`

    これは所有者でも所属グループのメンバーでもない他人がこのファイル・ディレクトリに対してどんな権限を持っているか示す。

    * `r`・・・読み込み権限：有り
    * `-`・・・書き込み権限：無し
    * `x`・・・実行権限：有り

* 1つ目の`root`

  所有者を表す。

* 2つ目の`root`

  所属グループを表す。

* `Sep 11 21:42`

  最終更新日を表す。

権限や所有者の変更については次回の記事で解説する。

### ドキュメントルートに必要な権限

新たに作ったディレクトリをドキュメントルートに指定したが、このディレクトリの権限が正しくないと、ブラウザでアクセスしたときに`403`エラーが出る。

* Nginxは（難しい説明を抜きにすると）`root`ユーザーが実行するmasterプロセスと、`www-data`ユーザーが実行するworkerプロセスによって成り立っており、workerプロセス（つまり`www-data`ユーザー）がhttpリクエストに応じてhtmlファイルを取得したりしている。

* `www-data`ユーザーに対して

  * ドキュメントルートディレクトリ：実行権限
  * htmlファイルなどのWebコンテンツ：読み取り権限

  を与えてやれば良い。書き込み権限は与えない方がよい。

  詳細：[nginx \- nginxパーミッション \- ドキュメントルート\(Ubuntu\)](https://gakumon.tech/nginx/nginx_permission_main.html)

自分から見て`www-data`ユーザーは他人であり、異なるユーザーグループなので、

~~~shell
$ls -l www
total 4
drwxr-xr-x 2 (自分のユーザー名) (自分のユーザーグループ) 4096 Sep 19 11:42 html
~~~

の権限表示部分の3組目である`r-x`が確認ポイント。この中の実行権限である`x`が必要。

また、htmlファイルに関しては

~~~shell
$ ls -l ~/www/html
total 0
-rw-r--r-- 1 (ユーザー名) (ユーザーグループ) 0 Sep 19 13:37 update.html
~~~

の権限表示部分の3組目`r--`が確認ポイント。読み取り権限である`r`が必要。

